#!/usr/bin/env bash
set -euo pipefail

# codescope-init — Generate .mcp.json for CodeScope in any project
#
# Usage:
#   cd /path/to/project && codescope-init
#   codescope-init /path/to/project

info()  { printf '\033[1;34m==>\033[0m %s\n' "$*"; }
ok()    { printf '\033[1;32m OK\033[0m %s\n' "$*"; }
err()   { printf '\033[1;31mERR\033[0m %s\n' "$*" >&2; }

TARGET="${1:-.}"
TARGET="$(cd "$TARGET" && pwd)"
MCP_FILE="$TARGET/.mcp.json"

# Check if codescope-server is installed
if ! command -v codescope-server >/dev/null 2>&1; then
    err "codescope-server is not installed."
    echo ""
    echo "  Install it with:"
    echo "    curl -sSL https://raw.githubusercontent.com/AlrikOlson/codescope/master/server/setup.sh | bash"
    echo ""
    exit 1
fi

# Detect if binary was built with semantic search support
HAS_SEMANTIC=0
if codescope-server --help 2>&1 | grep -q -- '--semantic'; then
    HAS_SEMANTIC=1
fi

# Check for existing .mcp.json
if [ -f "$MCP_FILE" ]; then
    # Check if codescope is already configured
    if grep -q '"codescope"' "$MCP_FILE" 2>/dev/null; then
        ok "CodeScope already configured in $MCP_FILE"
        exit 0
    fi

    info ".mcp.json already exists at $MCP_FILE"
    printf "Add CodeScope to existing config? [Y/n] "
    read -r answer
    if [ "${answer:-Y}" != "${answer#[Nn]}" ]; then
        echo "Aborted."
        exit 0
    fi

    # Merge into existing .mcp.json
    if command -v python3 >/dev/null 2>&1; then
        MCP_FILE="$MCP_FILE" TARGET="$TARGET" HAS_SEMANTIC="$HAS_SEMANTIC" python3 -c "
import json, os
mcp_file = os.environ['MCP_FILE']
target = os.environ['TARGET']
has_semantic = os.environ.get('HAS_SEMANTIC', '0') == '1'
with open(mcp_file) as f:
    data = json.load(f)
args = ['--mcp', '--root', target]
if has_semantic:
    args.insert(1, '--semantic')
data.setdefault('mcpServers', {})['codescope'] = {
    'type': 'stdio',
    'command': 'codescope-server',
    'args': args
}
with open(mcp_file, 'w') as f:
    json.dump(data, f, indent=2)
    f.write('\n')
"
        ok "Added CodeScope to $MCP_FILE"
    else
        err "Cannot merge automatically (python3 not found)."
        echo ""
        echo "  Add this to your .mcp.json mcpServers manually:"
        echo ""
        echo '  "codescope": {'
        echo '    "type": "stdio",'
        echo '    "command": "codescope-server",'
        echo "    \"args\": [\"--mcp\", \"--root\", \"$TARGET\"]"
        echo '  }'
        exit 1
    fi
else
    # Create new .mcp.json
    if [ "$HAS_SEMANTIC" = "1" ]; then
        cat > "$MCP_FILE" <<EOF
{
  "mcpServers": {
    "codescope": {
      "type": "stdio",
      "command": "codescope-server",
      "args": ["--mcp", "--semantic", "--root", "$TARGET"]
    }
  }
}
EOF
    else
        cat > "$MCP_FILE" <<EOF
{
  "mcpServers": {
    "codescope": {
      "type": "stdio",
      "command": "codescope-server",
      "args": ["--mcp", "--root", "$TARGET"]
    }
  }
}
EOF
    fi
    ok "Created $MCP_FILE"
fi

echo ""
ok "CodeScope is ready!"
echo ""
if [ "$HAS_SEMANTIC" = "1" ]; then
    echo "  Open Claude Code in this directory — CodeScope tools are available (with semantic search)."
else
    echo "  Open Claude Code in this directory — CodeScope tools are available."
fi
echo ""
echo "  If Claude Code is already open here, restart it to pick up the new config."
echo ""
