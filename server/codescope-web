#!/usr/bin/env bash
set -euo pipefail

# codescope-web â€” Launch the CodeScope web UI for any project
#
# Usage:
#   codescope-web                    # browse current directory
#   codescope-web /path/to/project   # browse a specific project
#   PORT=9000 codescope-web          # custom port (auto-selects free port if unset)

TARGET="${1:-.}"
TARGET="$(cd "$TARGET" && pwd)"

if ! command -v codescope-server >/dev/null 2>&1; then
    echo "Error: codescope-server not found in PATH." >&2
    echo "Run setup.sh first: https://github.com/AlrikOlson/codescope" >&2
    exit 1
fi

# Find dist directory
if [[ "$(uname -s)" == MINGW* || "$(uname -s)" == MSYS* || "$(uname -s)" == CYGWIN* ]]; then
    DIST_DIR="${LOCALAPPDATA:-$APPDATA}/codescope/dist"
else
    DIST_DIR="$HOME/.local/share/codescope/dist"
fi
if [ ! -d "$DIST_DIR" ] || [ ! -f "$DIST_DIR/index.html" ]; then
    echo "Error: Web UI not installed at $DIST_DIR" >&2
    echo "Re-run setup.sh with Node.js available to build the web UI." >&2
    exit 1
fi

open_browser() {
    local url="$1"
    if command -v xdg-open >/dev/null 2>&1; then
        xdg-open "$url" 2>/dev/null || true
    elif command -v open >/dev/null 2>&1; then
        open "$url" 2>/dev/null || true
    elif command -v start >/dev/null 2>&1; then
        start "$url" 2>/dev/null || true
    elif command -v explorer.exe >/dev/null 2>&1; then
        explorer.exe "$url" 2>/dev/null || true
    fi
}

echo "Project: $TARGET"

# Start the server in the background, scanning stderr for the actual port.
# The server prints CODESCOPE_PORT=<n> to stderr after binding.
codescope-server --root "$TARGET" --dist "$DIST_DIR" 2>&1 | while IFS= read -r line; do
    echo "$line" >&2
    if [[ "$line" == CODESCOPE_PORT=* ]]; then
        ACTUAL_PORT="${line#CODESCOPE_PORT=}"
        open_browser "http://localhost:$ACTUAL_PORT" &
    fi
done
