name: Release

on:
  workflow_run:
    workflows: ["Integration Tests"]
    types: [completed]
    branches: [master]

permissions:
  contents: write

jobs:
  version:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.ai.outputs.new_tag }}
      skip: ${{ steps.ai.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Claude Agent SDK
        run: npm install @anthropic-ai/claude-agent-sdk

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: server

      - name: Build CodeScope from source
        run: |
          cargo build --release --manifest-path server/Cargo.toml
          cp server/target/release/codescope-server /usr/local/bin/codescope-server

      - name: Initialize CodeScope index
        run: codescope-server init .

      - name: AI release analysis
        id: ai
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node .github/scripts/ai-release.mjs

      - name: Update Cargo.toml, commit, and tag
        if: steps.ai.outputs.skip != 'true'
        run: |
          NEW_TAG="${{ steps.ai.outputs.new_tag }}"
          VERSION="${NEW_TAG#v}"
          COMMIT_MSG=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/tmp/ai-release-output.json', 'utf8'));
            process.stdout.write(data.commitMessage);
          ")

          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" server/Cargo.toml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add server/Cargo.toml
          git diff --cached --quiet || git commit -m "$COMMIT_MSG"
          git tag "$NEW_TAG"
          git push origin HEAD:master --tags

      - name: Upload AI release output
        if: steps.ai.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ai-release-output
          path: /tmp/ai-release-output.json
          retention-days: 1

  build:
    needs: version
    if: needs.version.outputs.skip != 'true'
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ needs.version.outputs.new_tag }}

  release:
    needs: [version, build]
    if: needs.version.outputs.skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Download AI release output
        uses: actions/download-artifact@v4
        with:
          name: ai-release-output
          path: /tmp

      - name: Read AI release body
        id: notes
        run: |
          BODY=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/tmp/ai-release-output.json', 'utf8'));
            process.stdout.write(data.releaseBody || '');
          ")
          if [ -z "$BODY" ]; then
            echo "use_generated=true" >> "$GITHUB_OUTPUT"
          else
            {
              echo "body<<RELEASE_BODY_DELIM"
              echo "$BODY"
              echo "RELEASE_BODY_DELIM"
            } >> "$GITHUB_OUTPUT"
            echo "use_generated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release (AI body)
        if: steps.notes.outputs.use_generated == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.new_tag }}
          body: ${{ steps.notes.outputs.body }}
          files: artifacts/*.tar.gz

      - name: Create GitHub Release (auto-generated)
        if: steps.notes.outputs.use_generated == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.new_tag }}
          generate_release_notes: true
          files: artifacts/*.tar.gz
